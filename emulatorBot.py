import timeimport numpyimport osimport cv2import subprocessfrom PIL import Imageemulator_list = []EMULATOR_KEY = "emulator"STATE_KEY = "state"# ScreenshotSCREENSHOT_NAME = "screenshot.png"CROPPED_SCREENSHOT_NAME = "cropped_screenshot.png"ORIGINAL_TV_IMAGE_NAME = "colorTV.png"ORIGINAL_CLOSE_AD_IMAGE_NAME = "closeAd.png"DIR_PATH = os.path.dirname(__file__)SCREENSHOT_PATH = os.path.join(DIR_PATH, "screenshots",SCREENSHOT_NAME)CROPPED_SCREENSHOT_PATH = os.path.join(DIR_PATH, "screenshots", CROPPED_SCREENSHOT_NAME)ORIGINAL_TV_IMAGE_PATH = os.path.join(DIR_PATH, "original", ORIGINAL_TV_IMAGE_NAME)ORIGINAL_CLOSE_AD_IMAGE_PATH = os.path.join(DIR_PATH, "original", ORIGINAL_CLOSE_AD_IMAGE_NAME)TV_LOCATION = {'x': 188, 'y': 277}TV_IMAGE_DIMENSIONS = {'left': 110, 'top': 180, 'right': 275, 'bottom': 360}# Close adCLOSE_AD_LOCATION = {'x': 1013, 'y': 55}CLOSE_AD_DIMENTIONS = {'left': 980, 'top': 30, 'right': 1050, 'bottom': 100}class CompareImage(object):    def __init__(self, image_1_path, image_2_path):        self.minimum_commutative_image_diff = 1        self.image_1_path = image_1_path        self.image_2_path = image_2_path    def compare_image(self):        image_1 = cv2.imread(self.image_1_path, 0)        image_2 = cv2.imread(self.image_2_path, 0)        commutative_image_diff = self.get_image_difference(image_1, image_2)        if commutative_image_diff < self.minimum_commutative_image_diff:            print("Matched")            return commutative_image_diff        return 10000    @staticmethod    def get_image_difference(image_1, image_2):        first_image_hist = cv2.calcHist([image_1], [0], None, [256], [0, 256])        second_image_hist = cv2.calcHist([image_2], [0], None, [256], [0, 256])        img_hist_diff = cv2.compareHist(first_image_hist, second_image_hist, cv2.HISTCMP_BHATTACHARYYA)        img_template_probability_match = cv2.matchTemplate(first_image_hist, second_image_hist, cv2.TM_CCOEFF_NORMED)[0][0]        img_template_diff = 1 - img_template_probability_match        # taking only 10% of histogram diff, since it's less accurate than template method        commutative_image_diff = (img_hist_diff / 10) + img_template_diff        return commutative_image_diffdef crop_screenshot(dimensions):    # Load the two images you want to compare    image_before = Image.open(SCREENSHOT_PATH)    cropped_image = image_before.crop(        (dimensions['left'], dimensions['top'], dimensions['right'], dimensions['bottom']))    # Save the cropped image    cropped_image.save(CROPPED_SCREENSHOT_PATH)    # wait for save    time.sleep(1)def click_on_ad(emulator_device):    perform_click(emulator_device, TV_LOCATION['x'], TV_LOCATION['y'])def click_exit_ad(emulator_device):    perform_click(emulator_device, CLOSE_AD_LOCATION['x'], CLOSE_AD_LOCATION['y'])def perform_click(emulator_device, x_pos, y_pos):    adb_command = f"adb -s {emulator_device[EMULATOR_KEY]} shell input tap {x_pos} {y_pos}"    subprocess.run(adb_command, shell=True)def take_screenshot(emulator_device):    adb_command = f"adb -s {emulator_device[EMULATOR_KEY]} exec-out screencap  -p > {SCREENSHOT_PATH}"    subprocess.run(adb_command, shell=True)    # wait for screenshot to be present    time.sleep(1)def get_emulators():    emulator_list.clear()    adb_command = f"adb devices"    result = subprocess.run(adb_command, capture_output=True, text=True, check=True, shell=True)    if len(result.stdout) > 0:        for line in result.stdout.split("\n"):            if EMULATOR_KEY in line:                emulator_list.append({EMULATOR_KEY: line.split("\t")[0], STATE_KEY: line.split("\t")[1]})def check_emulator_offline(emulator_device):    if emulator_device['state'] == "offline":        print(f"EMULATOR {emulator_device['emulator']} IS OFFLINE")        return Truedef are_images_similar(first_image, second_image):    compare_image = CompareImage(first_image, second_image)    image_difference = compare_image.compare_image()    print(f"Images are diferent in percent : {image_difference}")    return image_difference < 0.12if __name__ == '__main__':    # get all emulators and check their state    get_emulators()    if len(emulator_list) == 0:        print("No running emulators, exiting")        exit(1)    for emulator in emulator_list:        check_emulator_offline(emulator)    # infinite loop    while (True):        for emulator in emulator_list:            # check if its online            if not check_emulator_offline(emulator):                # Look for TV ad                take_screenshot(emulator)                # crop screen for TV search                crop_screenshot(TV_IMAGE_DIMENSIONS)                if are_images_similar(CROPPED_SCREENSHOT_PATH, ORIGINAL_TV_IMAGE_PATH):                    print(f"EMULATOR: {emulator[EMULATOR_KEY]} has AD")                    click_on_ad(emulator)                    while True:                        # wait for ad                        time.sleep(5)                        # see if ad is over                        take_screenshot(emulator)                        crop_screenshot(CLOSE_AD_DIMENTIONS)                        if are_images_similar(CROPPED_SCREENSHOT_PATH, ORIGINAL_CLOSE_AD_IMAGE_PATH):                            print(f"EMULATOR: {emulator[EMULATOR_KEY]} can EXIT AD")                            click_exit_ad(emulator)                            break                        else:                            print(f"EMULATOR: {emulator[EMULATOR_KEY]} playing ADS")                else:                    print(f"EMULATOR: {emulator[EMULATOR_KEY]} has NO AD")        time.sleep(5)