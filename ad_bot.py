import loggingimport timeimport threadingfrom common import constants as constfrom common.custom_logger import loggerfrom common import common_utils as commondef crop_ad(emulator_device):    common.crop_screenshot(emulator_device, const.TV_IMAGE_DIMENSIONS, const.AD_SUFFIX)def crop_close_ad(emulator_device):    common.crop_screenshot(emulator_device, const.CLOSE_AD_DIMENSIONS, const.CLOSE_AD_SUFFIX)def crop_menu_button(emulator_device):    common.crop_screenshot(emulator_device, const.MENU_BUTTON_IMAGE_DIMENSIONS, const.MENU_BUTTON_SUFFIX)def crop_all(emulator_device):    crop_ad(emulator_device)    crop_close_ad(emulator_device)    crop_menu_button(emulator_device)def take_screenshot_and_crop_all(emulator_device):    common.take_screenshot(emulator_device)    crop_all(emulator_device)def take_screenshot_and_crop_ad(emulator_device):    common.take_screenshot(emulator_device)    crop_ad(emulator_device)def take_screenshot_and_crop_close_ad(emulator_device):    common.take_screenshot(emulator_device)    crop_close_ad(emulator_device)def take_screenshot_and_crop_menu(emulator_device):    common.take_screenshot(emulator_device)    crop_menu_button(emulator_device)def click_on_ad(emulator_device):    logger.debug(f"[{emulator_device.serial}]: clicking AD")    emulator_device.click(const.TV_LOCATION['x'], const.TV_LOCATION['y'])def click_exit_ad(emulator_device):    logger.debug(f"[{emulator_device.serial}]: exiting AD")    emulator_device.click(const.CLOSE_AD_LOCATION['x'], const.CLOSE_AD_LOCATION['y'])def is_close_ad_present(emulator_device):    logger.debug(f"[{emulator_device.serial}]: Looking for AD close button")    for image in const.ORIGINAL_CLOSE_AD_IMAGES_PATHS:        if common.are_images_similar(emulator_device, common.get_cropped_screenshot_path(emulator_device, const.CLOSE_AD_SUFFIX), image, const.CLOSE_AD_DIFF_THRESHOLD):            # This is redundant check to make sure it's not the main exit button            if not common.are_images_similar(emulator_device, common.get_cropped_screenshot_path(emulator_device, const.CLOSE_AD_SUFFIX), const.DONT_CLOSE_ADD_BUTTON_PATH, const.CLOSE_AD_DIFF_THRESHOLD):                return True    return Falsedef is_ad_present(emulator_device):    logger.debug(f"[{emulator_device.serial}]: Looking for AD")    return common.are_images_similar(emulator_device, common.get_cropped_screenshot_path(emulator_device, "ad"), const.ORIGINAL_TV_IMAGE_PATH, const.TV_IMAGE_DIFF_THRESHOLD)def is_in_tavern(emulator_device):    logger.debug(f"[{emulator_device.serial}]: Looking for menu button")    # need to check better for gambler or something    return common.are_images_similar(emulator_device, common.get_cropped_screenshot_path(emulator_device, const.MENU_BUTTON_SUFFIX), const.ORIGINAL_MENU_BUTTON_IMAGE_PATH, const.MENU_BUTTON_IMAGE_DIFF_THRESHOLD)def close_ad_if_playing(emulator_device):    logger.debug(f"[{emulator_device.serial}]: close ad if playing")    common.take_screenshot(emulator_device)    crop_close_ad(emulator_device)    if is_close_ad_present(emulator_device):        logger.debug(f"[{emulator_device.serial}]: closing ad")        click_exit_ad(emulator_device)        time.sleep(2)        close_ad_if_playing(emulator_device)    else:        logger.debug(f"[{emulator_device.serial}]: ad is not playing")        crop_menu_button(emulator_device)        if is_in_tavern(emulator_device):            logger.debug(f"[{emulator_device.serial}]: is in tavern")def watch_ad_and_close_after(emulator_device):    click_on_ad(emulator_device)    time.sleep(5)    close_ad_if_playing(emulator_device)def check_device_loop(emulator):    logger.info(f"Running loop for: {emulator}")    while True:        # check if its online        if common.is_emulator_attached(emulator):            common.take_screenshot(emulator)            crop_ad(emulator)            if is_ad_present(emulator):                logger.info(f"[{emulator.serial}]: has AD")                watch_ad_and_close_after(emulator)            else:                close_ad_if_playing(emulator)        else:            logger.error(f"[{emulator.serial}]: is offline")            breakif __name__ == '__main__':    logger.setLevel(logging.DEBUG)    logger.info("Started Shakes_AD_Bot")    # check installed adb    common.check_cli_tools_installed()    adb = common.get_adb_client()    emulator_device_list = adb.device_list()    thread_list = []    if len(emulator_device_list) == 0 or (len(emulator_device_list) == 1 and emulator_device_list[0].info == "offline"):        logger.error("No running emulators, exiting now.")        exit(1)    for device in emulator_device_list:        thread = threading.Thread(target=check_device_loop, args=(device,))        thread.start()        thread_list.append(thread)    try:        while True:            pass    except KeyboardInterrupt:        logger.debug("Program status: Ending program.")        for thread in thread_list:            thread.join()